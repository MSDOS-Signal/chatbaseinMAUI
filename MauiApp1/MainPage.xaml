<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:converters="clr-namespace:MauiApp1.Converters"
             xmlns:models="clr-namespace:MauiApp1.Models"
             x:Class="MauiApp1.MainPage"
             Title="炘灏AI"
             Background="{AppThemeBinding Light={StaticResource BackgroundGradientLight}, Dark={StaticResource BackgroundGradientDark}}">

    <ContentPage.Resources>
        <converters:MessageTypeToVisibilityConverter x:Key="MessageTypeToVisibilityConverter" />
    </ContentPage.Resources>

    <Grid>
        <!-- 侧边栏遮罩层 - 点击空白处关闭侧边栏 -->
        <Grid x:Name="SidebarOverlay"
              BackgroundColor="#80000000"
              IsVisible="{Binding IsSidebarVisible}"
              ZIndex="999">
            <Grid.GestureRecognizers>
                <TapGestureRecognizer Command="{Binding ToggleSidebarCommand}" />
            </Grid.GestureRecognizers>
        </Grid>

        <!-- 侧边栏 -->
        <Grid x:Name="Sidebar" 
              Background="{AppThemeBinding Light={StaticResource CardColorLight}, Dark={StaticResource CardColorDark}}"
              WidthRequest="280"
              HorizontalOptions="Start"
              ZIndex="1000"
              IsVisible="{Binding IsSidebarVisible}">
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto" />
                <RowDefinition Height="*" />
            </Grid.RowDefinitions>

            <!-- 侧边栏标题 -->
            <Grid Grid.Row="0" 
                  Padding="16,12"
                  Background="{AppThemeBinding Light={StaticResource SurfaceColorLight}, Dark={StaticResource SurfaceColorDark}}">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*" />
                    <ColumnDefinition Width="Auto" />
                </Grid.ColumnDefinitions>
                
                <StackLayout Grid.Column="0" 
                             Orientation="Horizontal" 
                             VerticalOptions="Center">
                    <Label Text="对话历史" 
                           FontSize="18" 
                           FontAttributes="Bold"
                           TextColor="{AppThemeBinding Light={StaticResource TextColorLight}, Dark={StaticResource TextColorDark}}"
                           VerticalOptions="Center" />
                    <Label Text="{Binding Sessions.Count, StringFormat='({0})'}" 
                           FontSize="14"
                           TextColor="{AppThemeBinding Light={StaticResource TextSecondaryColorLight}, Dark={StaticResource TextSecondaryColorDark}}"
                           VerticalOptions="Center"
                           Margin="8,0,0,0" />
                </StackLayout>
                
                <Button Grid.Column="1" 
                       Text="新对话"
                       FontSize="14"
                       FontAttributes="Bold"
                       TextColor="White"
                       Background="{StaticResource NewChatGradient}"
                       Command="{Binding NewChatCommand}"
                       WidthRequest="80"
                       HeightRequest="32"
                       CornerRadius="16"
                       VerticalOptions="Center"
                       Margin="0,0,0,0"
                       Scale="1.0">
                    <Button.Triggers>
                        <DataTrigger TargetType="Button" Binding="{Binding Source={RelativeSource Self}, Path=IsPressed}" Value="True">
                            <Setter Property="Scale" Value="0.95" />
                            <Setter Property="Background" Value="{StaticResource NewChatGradientHover}" />
                        </DataTrigger>
                    </Button.Triggers>
                </Button>
            </Grid>

            <!-- 对话列表 -->
            <CollectionView Grid.Row="1" 
                           ItemsSource="{Binding Sessions}"
                           Margin="8">
                <CollectionView.ItemTemplate>
                    <DataTemplate>
                        <Grid Margin="4,2" Padding="8,4">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*" />
                                <ColumnDefinition Width="Auto" />
                            </Grid.ColumnDefinitions>

                            <StackLayout Grid.Column="0" 
                                         Orientation="Vertical" 
                                         Spacing="2">
                                <Label Text="{Binding Title}" 
                                       FontSize="14" 
                                       FontAttributes="Bold"
                                       TextColor="{AppThemeBinding Light={StaticResource TextColorLight}, Dark={StaticResource TextColorDark}}"
                                       LineBreakMode="TailTruncation" />
                                <Label Text="{Binding LastModified, StringFormat='{0:MM-dd HH:mm}'}" 
                                       FontSize="12"
                                       TextColor="{AppThemeBinding Light={StaticResource TextSecondaryColorLight}, Dark={StaticResource TextSecondaryColorDark}}" />
                            </StackLayout>

                            <Button Grid.Column="1" 
                                    Text="×"
                                    FontSize="16"
                                    FontAttributes="Bold"
                                    TextColor="{AppThemeBinding Light={StaticResource ErrorColor}, Dark={StaticResource ErrorColor}}"
                                    BackgroundColor="Transparent"
                                    Command="{Binding Source={RelativeSource AncestorType={x:Type ContentPage}}, Path=BindingContext.DeleteSessionCommand}"
                                    CommandParameter="{Binding}"
                                    WidthRequest="30"
                                    HeightRequest="30"
                                    CornerRadius="15"
                                    Margin="8,0,0,0" />
                            
                            <Grid.GestureRecognizers>
                                <TapGestureRecognizer Command="{Binding Source={RelativeSource AncestorType={x:Type ContentPage}}, Path=BindingContext.SwitchSessionCommand}" 
                                                     CommandParameter="{Binding}" />
                            </Grid.GestureRecognizers>
                        </Grid>
                    </DataTemplate>
                </CollectionView.ItemTemplate>
            </CollectionView>
        </Grid>

        <!-- 主内容区域 -->
        <Grid x:Name="MainContent"
              Margin="{Binding IsSidebarVisible, Converter={StaticResource BoolToMarginConverter}}">
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto" />
                <RowDefinition Height="*" />
                <RowDefinition Height="Auto" />
            </Grid.RowDefinitions>

            <!-- 顶部标题栏 -->
            <Grid Grid.Row="0" 
                  Background="{AppThemeBinding Light={StaticResource CardColorLight}, Dark={StaticResource CardColorDark}}"
                  Padding="16,8">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="Auto" />
                    <ColumnDefinition Width="*" />
                    <ColumnDefinition Width="Auto" />
                </Grid.ColumnDefinitions>

                <Button Grid.Column="0" 
                        Text="☰"
                        Style="{StaticResource ThemeToggleButton}"
                        Command="{Binding ToggleSidebarCommand}" />

                <StackLayout Grid.Column="1" Orientation="Horizontal" Spacing="12">
                    <Label Text="炘灏AI" 
                           FontSize="24" 
                           FontAttributes="Bold"
                           TextColor="{AppThemeBinding Light={StaticResource TextColorLight}, Dark={StaticResource TextColorDark}}"
                           VerticalOptions="Center" />
                    
                    <Frame Background="{StaticResource PrimaryGradient}" 
                           CornerRadius="12" 
                           Padding="8,4"
                           VerticalOptions="Center">
                        <Label Text="Qwen2.5(72B)" 
                               TextColor="White" 
                               FontSize="12" 
                               FontAttributes="Bold" />
                    </Frame>
                </StackLayout>

                <StackLayout Grid.Column="2" 
                            Orientation="Horizontal" 
                            Spacing="8">
                    <Label Text="{Binding CurrentUser.Username}"
                           FontSize="14"
                           TextColor="{AppThemeBinding Light={StaticResource TextColorLight}, Dark={StaticResource TextColorDark}}"
                           VerticalOptions="Center" />
                    
                    <Button Text="{Binding IsDarkMode, Converter={StaticResource BoolToThemeIconConverter}}"
                            Style="{StaticResource ThemeToggleButton}"
                            Command="{Binding ToggleThemeCommand}" />
                    
                    <Button Text="登出"
                            Style="{StaticResource ThemeToggleButton}"
                            Command="{Binding LogoutCommand}"
                            IsVisible="{Binding IsLoggedIn}" />
                </StackLayout>
            </Grid>

                        <!-- 聊天消息区域 -->
            <CollectionView Grid.Row="1"
                            x:Name="ChatCollectionView"
                            ItemsSource="{Binding CurrentSession.Messages}"
                            Margin="16,8">
                <CollectionView.ItemTemplate>
                    <DataTemplate>
                        <Grid Margin="0,4">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*" />
                                <ColumnDefinition Width="Auto" />
                            </Grid.ColumnDefinitions>

                            <!-- 用户消息 -->
                            <Frame Grid.Column="1" 
                                   Style="{StaticResource ChatBubbleUser}"
                                   IsVisible="{Binding Type, Converter={StaticResource MessageTypeToVisibilityConverter}, ConverterParameter=User}">
                                <Label Text="{Binding Content}" 
                                       Style="{StaticResource MessageTextUser}" />
                            </Frame>

                            <!-- AI消息 -->
                            <Frame Grid.Column="0" 
                                   Style="{StaticResource ChatBubbleAssistant}"
                                   IsVisible="{Binding Type, Converter={StaticResource MessageTypeToVisibilityConverter}, ConverterParameter=Assistant}">
                                <Label FormattedText="{Binding Content, Converter={StaticResource MarkdownConverter}}" 
                                       Style="{StaticResource MessageText}" />
                            </Frame>
                        </Grid>
                    </DataTemplate>
                </CollectionView.ItemTemplate>
            </CollectionView>

            <!-- 底部输入区域 -->
            <Grid Grid.Row="2" 
                  Background="{AppThemeBinding Light={StaticResource CardColorLight}, Dark={StaticResource CardColorDark}}"
                  Padding="16,12">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="Auto" />
                    <ColumnDefinition Width="*" />
                    <ColumnDefinition Width="Auto" />
                </Grid.ColumnDefinitions>

                <Button Grid.Column="0" 
                        Text="新对话"
                        FontSize="14"
                        FontAttributes="Bold"
                        TextColor="White"
                        Background="{StaticResource NewChatGradient}"
                        Command="{Binding NewChatCommand}"
                        WidthRequest="80"
                        HeightRequest="36"
                        CornerRadius="18"
                        Margin="0,0,8,0"
                        Scale="1.0">
                    <Button.Triggers>
                        <DataTrigger TargetType="Button" Binding="{Binding Source={RelativeSource Self}, Path=IsPressed}" Value="True">
                            <Setter Property="Scale" Value="0.95" />
                            <Setter Property="Background" Value="{StaticResource NewChatGradientHover}" />
                        </DataTrigger>
                    </Button.Triggers>
                </Button>

                <Frame Grid.Column="1" 
                       BackgroundColor="{AppThemeBinding Light={StaticResource SurfaceColorLight}, Dark={StaticResource SurfaceColorDark}}"
                       CornerRadius="25" 
                       Padding="16,8"
                       Margin="0,0,8,0">
                    <Entry Text="{Binding InputText}" 
                           Style="{StaticResource InputBox}"
                           BackgroundColor="Transparent"
                           ReturnCommand="{Binding SendMessageCommand}" />
                </Frame>

                <Button Grid.Column="2" 
                        Text="发送"
                        Style="{StaticResource SendButton}"
                        Command="{Binding SendMessageCommand}"
                        IsEnabled="{Binding InputText, Converter={StaticResource StringToBoolConverter}}" />
            </Grid>

                        <!-- 加载指示器 - 改为更小的样式 -->
            <Grid Grid.Row="1"
                  IsVisible="{Binding IsLoading}"
                  VerticalOptions="End"
                  HorizontalOptions="End"
                  Margin="20">
                <ActivityIndicator IsRunning="{Binding IsLoading}"
                                   Color="{AppThemeBinding Light={StaticResource PrimaryColor}, Dark={StaticResource PrimaryColor}}"
                                   Scale="0.8" />
            </Grid>
        </Grid>
    </Grid>

</ContentPage>
